---
title: "Lupus data simulation DE results"
subtitle: "Celltype: `r params$celltypes`"
author: "Milan Malfait & Jeroen Gilis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    theme: flatly # use darkly for dark version
    highlight: tango
    toc: yes
    toc_float: yes
    df_print: paged
    number_sections: false
    code_folding: "hide"
params:
    methods: !r c("edgeR_NB", "qbGLM_offset_squeeze")
    prop_DE: !r c(0.01, 0.05, 0.1)
    celltypes: "ncM"
    datatype: "pb"
editor_options:
  chunk_output_type: console
---

<!-- NOTE: this report should be run with a single celltype only! -->

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    fig.width = 8,
    fig.asp = 0.618,
    out.width = "100%",
    fig.align = "center",
    collapse = TRUE,
    comment = "#>"
)
```

***

```{r libraries, message=FALSE, warning=FALSE, cache=FALSE}
library(here)
library(tidyverse)
library(cowplot)
library(GGally)
theme_set(theme_light(base_size = 14))

library(scuttle)
library(scater)
library(scran)

library(kableExtra)
library(SCandwichCompanion)
library(iCOBRA)
```


# Setup

```{r}
## Directory setup
here_root <- "benchmarks/lupus"
here::i_am(file.path(here_root, "analysis/lupus-sim-results.Rmd"))

data_dir <- here::here(here_root, "data")
stopifnot(dir.exists(data_dir))
res_dir <- here::here(here_root, "results")
stopifnot(dir.exists(res_dir))
```

```{r, echo=FALSE, results='asis'}
## Use 1 celltype per report
stopifnot(length(params$celltypes) == 1)
celltype <- params$celltypes

methods <- params$methods
prop_DE <- params$prop_DE
datatype <- params$datatype

cat(
  "\n* Using `methods`: ", paste(methods, collapse = ", "),
  "\n* Using `celltype`: ", celltype,
  "\n* Using `prop_DE`: ", paste(prop_DE, collapse = ", "),
  "\n* Using `datatype`: ", paste(datatype, collapse = ", ")
)
```

## Load results

```{r load-results}
res_files <- map(prop_DE, ~ get_sim_res_files(dataset = "lupus", 
                                              methods = methods,
                                              datatype = datatype,
                                              prop_DE = .x, 
                                              celltype = celltype
)) %>% set_names(paste0("prop_DE_", prop_DE))
res_list <- map_depth(res_files, 2, readRDS)

## Check for expected data structure
stopifnot(unlist(map_depth(res_list, 3, ~ is.data.frame(.x$results))))
```


## Load SCE objects

```{r load-SCE-objects}
sce_files <- map(prop_DE, ~ get_SCE_files(
    dataset = "lupus",
    which = "sim_replicates", prop_DE = .x,
    celltype = celltype
)) %>% set_names(paste0("prop_DE_", prop_DE))

sce_objects <- lapply(sce_files, readRDS)
```

# Data overview

* The results were generated from `r length(sce_objects)` simulation replicates
* Each replicate was generated by randomly splitting the subjects in two mock groups
* The same mock replicates were used for each `prop_DE` level. I.e.
  `prop_DE_0.1$replicate1` and `prop_DE_0.05$replicate1` will have the same mock
  group assignment
* DE was introduced by **swapping genes in one of the mock groups**
* Cells per subject were sub-sampled to **100 cells per subject**

```{r data-overview}
map_dfr(sce_objects,
    ~ map_dfr(.x, function(x) c(nrows = nrow(x), ncols = ncol(x)),
        .id = "replicate"
    ),
    .id = "prop_DE"
)
```

Subjects are divided across mock groups as follows:

```{r}
lapply(sce_objects[[1]], function(x) table(x$ind_cov, x$mock_group))
```

The number of DE and non-DE genes per replicate:

```{r}
map(sce_objects, ~ map_dfr(.x, ~ table(rowData(.x)$is_DE), .id = "replicate"))
```

## t-SNE plots {.tabset}

```{r tSNE_plots}
tSNE_plots <- map(sce_objects, function(x) {
    p <- imap(x, function(sce, name) {
        plotTSNE(sce, colour_by = "mock_group") +
            ggtitle(name)
    })
    patchwork::wrap_plots(p, ncol = 3, guides = "collect")
})
```

```{r, results='asis', echo=FALSE}
print_plots(tSNE_plots, use_names = paste("Prop. DE =", prop_DE))
```



# Extract results of interest

## Runtimes

```{r}
## Get runtimes for each celltype
runtimes <- map(res_list, ~ map_dfr(.x, get_runtimes, depth = 1, .id = "method"))
```


## P-values

```{r res_tables}
res_tables <- map_depth(res_list, 2, get_aggregated_rep_tables, depth = 1)
res_tables <- map(res_tables, ~ combine_tables(.x, .id = "method"))
```


# Visualize results

## Run times {.tabset}

```{r runtimes-plot}
runtime_plots <- imap(
    runtimes,
    ~ plot_run_times(.x, width = 0.2, height = 0) +
        ggtitle(.y)
)
```

```{r, results='asis', echo=FALSE}
print_plots(runtime_plots)
```


## P-value distributions {.tabset}

```{r pvalue-distributions, fig.width=16}
pval_figs <- map(res_tables, ~ pval_hist(.x))
```

```{r, results='asis', echo=FALSE}
print_plots(pval_figs)
```


## P-value distributions for non-DE genes {.tabset}

```{r}
non_de_res <- map2(sce_objects, res_tables, function(sce_list, res) {
    by_rep <- split(res, res$replicate)
    out <- map2(sce_list, by_rep, function(sce, tbl) {
        ## Select only non-DE genes
        non_de <- rownames(sce)[!rowData(sce)$is_DE]
        tbl[tbl$gene %in% non_de, ]
    })
    bind_rows(out, .id = "replicate")
})
```

```{r non-DEpvalue-distributions, fig.width=16}
non_de_pval_figs <- map(non_de_res, ~ pval_hist(.x))
```

```{r, results='asis', echo=FALSE}
print_plots(non_de_pval_figs)
```


# Performance evaluation with `iCOBRA`

## Prepare Data

P-values for missing genes are set to 1.

```{r missing-genes, echo=FALSE, fig.width=16}
tmp_cobra <- map2(res_tables, sce_objects, function(res_table, sce_list) {
    ## Split up results per replicate
    res_per_replicate <- split(res_table, res_table$replicate)
    map2(res_per_replicate, sce_list,
        ~ prepare_COBRAData(.x, .y, replace_missing = FALSE)
    )
})

## Missing genes per method
prop_missing <- map_depth(tmp_cobra, 2,
    ~ map_dbl(pval(.x), ~ mean(is.na(.x)))
) %>%
    map_dfr(~ bind_rows(.x, .id = "replicate"), .id = "prop_DE")

prop_missing %>%
    pivot_longer(!c("prop_DE", "replicate"), names_to = "method") %>%
    mutate(method = fct_reorder(method, value)) %>%
    ggplot(aes(method, value)) +
        geom_col(show.legend = FALSE) +
        labs(
            x = "Method", y = "Proportion of missing genes",
            title = "Missing genes"
        ) +
        scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
        coord_flip() +
        facet_grid(rows = vars(prop_DE), cols = vars(replicate)) +
        theme_minimal(base_size = 14) +
        theme(panel.grid.major.y = element_blank(),
              panel.grid.minor = element_blank())
```



```{r cobra-prep}
cobra_data <- map2(res_tables, sce_objects, function(res_table, sce_list) {
    ## Split up results per replicate
    res_per_replicate <- split(res_table, res_table$replicate)
    map2(res_per_replicate, sce_list, prepare_COBRAData, replace_missing = TRUE)
})

cobra_perf <- map_depth(cobra_data, 2, calculate_performance, binary_truth = "status")

n_methods <- length(unique(res_tables[[1]]$method)) + 1 # +1 for "truth"
cobra_objects <- map_depth(cobra_perf, 2, prepare_data_for_plot)
```


## TPR plots {.tabset}

```{r tpr-plots}
no_legend <- theme(legend.position = "none")
tpr_plots <- map(cobra_objects, function(cobra_list) {
    p <- imap(cobra_list, ~ plot_tpr(.x, title = .y) + no_legend)
    patchwork::wrap_plots(p, ncol = 3)
})
```

```{r, echo=FALSE, fig.width=16, results='asis'}
print_plots(tpr_plots)
```


## FPR plots {.tabset}

```{r fpr-plots}
fpr_plots <- map(cobra_objects, function(cobra_list) {
    p <- imap(cobra_list, ~ plot_fpr(.x, title = .y) + no_legend)
    patchwork::wrap_plots(p, ncol = 3)
})
```

```{r, echo=FALSE, fig.width=16, results='asis'}
print_plots(fpr_plots)
```


## FDR-TPR curves {.tabset}

```{r fdr_tpr-plots}
fdr_tpr_plots <- map(cobra_objects, function(cobra_list) {
    p <- imap(cobra_list, ~ plot_fdrtprcurve(.x, title = .y))
    patchwork::wrap_plots(p, ncol = 3, guides = "collect")
})
```

```{r, echo=FALSE, fig.width=16, results='asis', warning=FALSE}
print_plots(fdr_tpr_plots)
```


## Zoomed FDR-TPR curves {.tabset}

Same plots but zoomed on the FDR-TPR points region.

```{r fdr_tpr_plots_zoomed}
fdr_tpr_plots_zoomed <- map(cobra_objects, function(cobra_list) {
    p <- imap(cobra_list, ~ plot_zoomed_fdrtprcurve(.x, title = .y))
    patchwork::wrap_plots(p, ncol = 3, guides = "collect")
})
```

```{r, echo=FALSE, fig.width=16, results='asis', warning=FALSE}
print_plots(fdr_tpr_plots_zoomed)
```

# Session info {-}

<details><summary>Session info</summary>

```{r session_info, echo=FALSE, cache=FALSE}
Sys.time()
git2r::repository()
sessioninfo::session_info()
```

</details>
