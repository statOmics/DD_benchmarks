---
title: "Lupus data simulation DE results"
subtitle: "Celltype: `r params$celltypes`"
author: "Milan Malfait"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    theme: flatly # use darkly for dark version
    highlight: tango
    toc: yes
    toc_float: yes
    df_print: paged
    number_sections: false
    code_folding: "hide"
params:
    methods: !r c("muscat", "sandwichTtestLR")
    prop_DE: !r c(0.01, 0.05, 0.1)
    celltypes: "combined"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    fig.width = 16,
    fig.asp = 0.618,
    out.width = "100%",
    fig.align = "center",
    collapse = TRUE,
    comment = "#>"
)
```

***

```{r libraries, message=FALSE, warning=FALSE, cache=FALSE}
library(here)
library(tidyverse)
library(cowplot)
library(GGally)
theme_set(theme_light(base_size = 14))

library(scuttle)
library(scater)
library(scran)

library(kableExtra)
library(SCandwichCompanion)
library(iCOBRA)
```


# Setup

```{r}
## Directory setup
here_root <- "benchmarks/lupus"
here::i_am(file.path(here_root, "analysis/lupus-sim-results.Rmd"))

data_dir <- here::here(here_root, "data")
stopifnot(dir.exists(data_dir))
res_dir <- here::here(here_root, "results")
stopifnot(dir.exists(res_dir))
```

```{r, echo=FALSE, results='asis'}
## Use 1 celltype per report
stopifnot(length(params$celltypes) == 1)
celltype <- params$celltypes

methods <- params$methods
prop_DE <- params$prop_DE

cat(
  "\n* Using `methods`: ", paste(methods, collapse = ", "),
  "\n* Using `celltype`: ", celltype,
  "\n* Using `prop_DE`: ", paste(prop_DE, collapse = ", ")
)
```

## Load results

```{r load-results}
res_files <- map(prop_DE, ~ get_sim_res_files(
    dataset = "lupus", methods = methods,
    prop_DE = .x, celltype = celltype
)) %>% set_names(paste0("prop_DE_", prop_DE))
res_list <- map_depth(res_files, 2, readRDS)

## Check for expected data structure
stopifnot(unlist(map_depth(res_list, 4, ~ is.data.frame(.x$results))))
```


## Load SCE objects

```{r load-SCE-objects}
sce_files <- map(prop_DE, ~ get_SCE_files(
    dataset = "lupus",
    which = "sim_replicates", prop_DE = .x,
    celltype = celltype
)) %>% set_names(paste0("prop_DE_", prop_DE))
sce_objects <- lapply(sce_files, readRDS)
```

# Data overview

* The results were generated from `r length(sce_objects)` simulation replicates
* Each replicate was generated by randomly splitting the subjects in two mock groups
* The same mock replicates were used for each `prop_DE` level. I.e.
  `prop_DE_0.1$replicate1` and `prop_DE_0.05$replicate1` will have the same mock
  group assignment
* DE was introduced by **swapping genes in one of the mock groups**
* Cells per subject were sub-sampled to **100 cells per subject**

```{r data-overview}
map_dfr(sce_objects,
    ~ map_dfr(.x, function(x) c(nrows = nrow(x), ncols = ncol(x)),
        .id = "replicate"
    ),
    .id = "prop_DE"
)
```

Subjects are divided across mock groups as follows:

```{r}
lapply(sce_objects[[1]], function(x) table(x$ind_cov, x$mock_group))
```

The number of DE and non-DE genes per replicate:

```{r}
map(sce_objects, ~ map_dfr(.x, ~ table(rowData(.x)$is_DE), .id = "replicate"))
```

## t-SNE plots {.tabset}

t-SNE plots **colored by _celltype_, shaped by _mock_group_**.

```{r tSNE_plots}
tSNE_plots <- map(sce_objects, function(x) {
    p <- imap(x, function(sce, name) {
        plotTSNE(sce, colour_by = "ct_cov", shape_by = "mock_group") +
            ggtitle(name)
    })
    patchwork::wrap_plots(p, ncol = 3, guides = "collect")
})
```

```{r, results='asis', echo=FALSE}
print_plots(tSNE_plots, use_names = paste("Prop. DE =", prop_DE))
```



# Extract results of interest

## Runtimes

```{r}
## Nest methods below celltypes
res_list <- map(res_list, transpose)

## Get runtimes for each celltype
runtimes <- map_depth(res_list, 2,
    ~ map_dfr(.x, get_runtimes, depth = 1, .id = "method")
) %>%
    map(bind_rows, .id = "celltype")
```


## P-values

```{r res_tables}
res_tables <- map_depth(res_list, 3, get_aggregated_rep_tables, depth = 1)
res_tables <- map_depth(res_tables, 2, ~ combine_tables(.x, .id = "method"))
```


# Visualize results

## Run times {.tabset}

```{r runtimes-plot}
runtime_plots <- imap(
    runtimes,
    ~ plot_run_times(.x, width = 0.2, height = 0) +
        ggtitle(.y) +
        facet_wrap(vars(celltype))
)
```

```{r, results='asis', echo=FALSE}
print_plots(runtime_plots)
```


## P-value distributions

```{r pvalue-distributions, fig.width=16}
pval_figs <- map_depth(res_tables, 2, ~ pval_hist(.x))
```


<!-- ### `prop_DE = 0.01` {.tabset} -->

<!-- ```{r, results='asis', echo=FALSE} -->
<!-- print_plots(pval_figs$prop_DE_0.01, header_level = 4) -->
<!-- ``` -->

### `prop_DE = 0.05` {.tabset}

```{r, results='asis', echo=FALSE}
print_plots(pval_figs$prop_DE_0.05, header_level = 4)
```

<!-- ### `prop_DE = 0.1` {.tabset} -->

<!-- ```{r, results='asis', echo=FALSE} -->
<!-- print_plots(pval_figs$prop_DE_0.1, header_level = 4) -->
<!-- ``` -->


## P-value distributions for non-DE genes

```{r}
non_de_res <- map2(res_tables, sce_objects, function(res_by_ct, sce_by_rep) {
    map(res_by_ct, function(res_table) {
        res_by_rep <- split(res_table, res_table$replicate)
        out <- map2(res_by_rep, sce_by_rep, function(tbl, sce) {
            ## Select only non-DE genes
            non_de <- rownames(sce)[!rowData(sce)$is_DE]
            tbl[tbl$gene %in% non_de, ]
        })
        bind_rows(out, .id = "replicate")
    })
})
```

```{r non-DEpvalue-distributions, fig.width=16}
non_de_pval_figs <- map_depth(non_de_res, 2, ~ pval_hist(.x))
```

<!-- ### `prop_DE = 0.01` {.tabset} -->

<!-- ```{r, results='asis', echo=FALSE} -->
<!-- print_plots(non_de_pval_figs$prop_DE_0.01, header_level = 4) -->
<!-- ``` -->

### `prop_DE = 0.05` {.tabset}

```{r, results='asis', echo=FALSE}
print_plots(non_de_pval_figs$prop_DE_0.05, header_level = 4)
```

<!-- ### `prop_DE = 0.1` {.tabset} -->

<!-- ```{r, results='asis', echo=FALSE} -->
<!-- print_plots(non_de_pval_figs$prop_DE_0.1, header_level = 4) -->
<!-- ``` -->


# Performance evaluation with `iCOBRA`

## Prepare Data

P-values for missing genes are set to 1.

```{r cobra-prep}
cobra_data <- map2(res_tables, sce_objects, function(res_by_ct, sce_by_rep) {
    map(res_by_ct, function(res_table) {
        res_by_rep <- split(res_table, res_table$replicate)
        map2(res_by_rep, sce_by_rep, prepare_COBRAData, replace_missing = TRUE)
    })
})

cobra_perf <- map_depth(cobra_data, 3, calculate_performance, binary_truth = "status")

n_methods <- length(unique(res_tables[[1]][[1]]$method)) + 1 # +1 for "truth"
cobra_objects <- map_depth(cobra_perf, 3, prepare_data_for_plot)
```


## TPR plots

```{r tpr-plots}
no_legend <- theme(legend.position = "none")
tpr_plots <- map_depth(cobra_objects, 2, function(cobra_list) {
    p <- imap(cobra_list, ~ plot_tpr(.x, title = .y) + no_legend)
    patchwork::wrap_plots(p, ncol = 3)
})
```

<!-- ### `prop_DE = 0.01` {.tabset} -->

<!-- ```{r, results='asis', echo=FALSE} -->
<!-- print_plots(tpr_plots$prop_DE_0.01, header_level = 4) -->
<!-- ``` -->

### `prop_DE = 0.05` {.tabset}

```{r, results='asis', echo=FALSE}
print_plots(tpr_plots$prop_DE_0.05, header_level = 4)
```

<!-- ### `prop_DE = 0.1` {.tabset} -->

<!-- ```{r, results='asis', echo=FALSE} -->
<!-- print_plots(tpr_plots$prop_DE_0.1, header_level = 4) -->
<!-- ``` -->


## FPR plots

```{r fpr-plots}
fpr_plots <- map_depth(cobra_objects, 2, function(cobra_list) {
    p <- imap(cobra_list, ~ plot_fpr(.x, title = .y) + no_legend)
    patchwork::wrap_plots(p, ncol = 3)
})
```

<!-- ### `prop_DE = 0.01` {.tabset} -->

<!-- ```{r, results='asis', echo=FALSE} -->
<!-- print_plots(fpr_plots$prop_DE_0.01, header_level = 4) -->
<!-- ``` -->

### `prop_DE = 0.05` {.tabset}

```{r, results='asis', echo=FALSE}
print_plots(fpr_plots$prop_DE_0.05, header_level = 4)
```

<!-- ### `prop_DE = 0.1` {.tabset} -->

<!-- ```{r, results='asis', echo=FALSE} -->
<!-- print_plots(fpr_plots$prop_DE_0.1, header_level = 4) -->
<!-- ``` -->


## FDR-TPR curves

```{r fdr_tpr-plots}
fdr_tpr_plots <- map_depth(cobra_objects, 2, function(cobra_list) {
    p <- imap(cobra_list, ~ plot_fdrtprcurve(.x, title = .y))
    patchwork::wrap_plots(p, ncol = 3, guides = "collect")
})
```

<!-- ### `prop_DE = 0.01` {.tabset} -->

<!-- ```{r, echo=FALSE, fig.width=16, results='asis', warning=FALSE} -->
<!-- print_plots(fdr_tpr_plots$prop_DE_0.01, header_level = 4) -->
<!-- ``` -->

### `prop_DE = 0.05` {.tabset}

```{r, echo=FALSE, fig.width=16, results='asis', warning=FALSE}
print_plots(fdr_tpr_plots$prop_DE_0.05, header_level = 4)
```

<!-- ### `prop_DE = 0.1` {.tabset} -->

<!-- ```{r, echo=FALSE, fig.width=16, results='asis', warning=FALSE} -->
<!-- print_plots(fdr_tpr_plots$prop_DE_0.1, header_level = 4) -->
<!-- ``` -->


## Zoomed FDR-TPR curves

Same plots but zoomed on the FDR-TPR points region.

```{r fdr_tpr_plots_zoomed}
fdr_tpr_plots_zoomed <- map_depth(cobra_objects, 2, function(cobra_list) {
    p <- imap(cobra_list, ~ plot_zoomed_fdrtprcurve(.x, title = .y))
    patchwork::wrap_plots(p, ncol = 3, guides = "collect")
})
```

<!-- ### `prop_DE = 0.01` {.tabset} -->

<!-- ```{r, echo=FALSE, fig.width=16, results='asis', warning=FALSE} -->
<!-- print_plots(fdr_tpr_plots_zoomed$prop_DE_0.01, header_level = 4) -->
<!-- ``` -->

### `prop_DE = 0.05` {.tabset}

```{r, echo=FALSE, fig.width=16, results='asis', warning=FALSE}
print_plots(fdr_tpr_plots_zoomed$prop_DE_0.05, header_level = 4)
```

<!-- ### `prop_DE = 0.1` {.tabset} -->

<!-- ```{r, echo=FALSE, fig.width=16, results='asis', warning=FALSE} -->
<!-- print_plots(fdr_tpr_plots_zoomed$prop_DE_0.1, header_level = 4) -->
<!-- ``` -->


# Session info {-}

<details><summary>Session info</summary>

```{r session_info, echo=FALSE, cache=FALSE}
Sys.time()
git2r::repository()
sessioninfo::session_info()
```

</details>
