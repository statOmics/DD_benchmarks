---
title: "Lupus data mock DE results"
authors: "Milan Malfait & Jeroen Gilis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    theme: flatly # use darkly for dark version
    highlight: tango
    toc: yes
    toc_float: yes
    df_print: paged
    number_sections: false
    code_folding: "hide"
params:
    methods: !r c("muscat", "ttest")
    celltypes: "ncM"
    datatype: "sce"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    fig.width = 8,
    fig.asp = 0.618,
    out.width = "100%",
    fig.align = "center",
    collapse = TRUE,
    comment = "#>"
)
```

***

```{r libraries, message=FALSE, warning=FALSE, cache=FALSE}
library(here)
library(tidyverse)
library(cowplot)
library(GGally)
theme_set(theme_light())

library(scuttle)
library(scater)

library(kableExtra)
library(SCandwichCompanion)
```

# Setup

```{r}
## Directory setup
here_root <- "benchmarks/lupus"
here::i_am(file.path(here_root, "analysis/lupus-mock-results.Rmd"))

res_dir <- here::here(here_root, "results")
fig_dir <- here::here(here_root, "figures")
```

```{r, echo=FALSE, results='asis'}
methods <- params$methods
celltypes <- params$celltypes
datatype <- params$datatype

cat(
  "\n* Using `methods`: ", paste(methods, collapse = ", "),
  "\n* Using `celltypes`: ", paste(celltypes, collapse = ", "),
  "\n* Using `datatype`: ", paste(datatype, collapse = ", ")
)
```

## Load results

```{r load-results}
res_files <- map(celltypes, ~ get_mock_res_files(
    dataset = "lupus",
    datatype = datatype,
    methods = methods,
    celltype = .x
)) %>%
    set_names(celltypes)

res_list <- map_depth(res_files, 2, readRDS)

## Check for expected data structure
stopifnot(unlist(map_depth(res_list, 3, ~ is.data.frame(.x$results))))
```

## Load SCE objects

```{r load-SCE-objects}
data_files <- map(celltypes, ~ get_SCE_files(
    dataset = "lupus", which = "mock_replicates",
    celltype = .x
)) %>%
    set_names(celltypes)
sce_objects <- map(data_files, readRDS)
```

# Data overview

* The results were generated from `r length(sce_objects[[1]])` mock replicates
* Each replicate was generated by randomly splitting the subjects in two mock groups
* No sub-sampling of cells per patient was performed for this data

```{r data-overview}
map_dfr(sce_objects,
    ~ map_dfr(.x, function(x) c(nrows = nrow(x), ncols = ncol(x)),
        .id = "replicate"
    ),
    .id = "celltypes"
)
```

Subjects are divided across mock groups as follows:

```{r}
map(sce_objects[[1]], function(x) table(x$ind_cov, x$mock_group))
```



# Extract results of interest

## Runtimes

```{r}
## Get runtimes for each celltype
runtimes <- map(res_list, ~ map_dfr(.x, get_runtimes, depth = 1, .id = "method"))
```


## P-values

```{r res_tables}
res_tables <- map_depth(
    res_list, 2,
    ~ get_aggregated_rep_tables(.x, depth = 1)
) %>%
    map(combine_tables, .id = "method")
```


# Visualize results

## Run times {.tabset}

```{r runtimes-plot}
runtime_plots <- imap(runtimes,
    ~ plot_run_times(.x, width = 0.2, height = 0) +
      ggtitle(.y)
)
```

```{r, results='asis', echo=FALSE}
print_plots(runtime_plots)
```


## Number of significant genes for different FDR levels {.tabset}

```{r, message=FALSE}
n_sign_summaries <- map(res_tables, function(tmp) {
    tmp %>%
        group_by(replicate, method) %>%
        summarise(
            sum(FDR < 0.01),
            sum(FDR < 0.05),
            sum(FDR < 0.1),
            .groups = "drop"
        )
})
```

```{r, results='asis', echo=FALSE}
n_methods <- length(methods)

kbl_tables <- imap(
    n_sign_summaries,
    function(tmp, name) {
        n_replicates <- length(unique(tmp$replicate))
        pack_row_idx <- rep(n_methods, n_replicates)
        names(pack_row_idx) <- paste("Replicate:", seq_len(n_replicates))

        cells_per_patient <- str_remove(name, "cells_per_patient_")
        title <- paste("Cells per patient:", cells_per_patient)

        ## Make Kable tables for printing
        cap <- title
        tmp %>%
            select(-replicate) %>%
            kableExtra::kbl(caption = cap) %>%
            kable_paper("striped") %>%
            pack_rows(index = pack_row_idx)
    }
)

iwalk(kbl_tables, function(x, i) {
    cat("\n\n### ", i, "\n\n")
    print(x)
})
```


## P-value distributions {.tabset}

```{r pvalue-distributions}
pval_figs <- map(res_tables, pval_hist)
```

```{r, results='asis', echo=FALSE, fig.width=12}
print_plots(pval_figs)
```

## P-value distributions stratified by expression level {.tabset}

For each replicate, calculate average log-normalized counts,
using `scuttle::calculateAverage()`.

```{r}
## Calculate average counts for each replicate
avg_counts <- map_depth(sce_objects, 2,
    ~ calculateAverage(counts(.x))
)

## Split res_tables per replicate
res_tables_split <- map(res_tables, ~ split(.x, .x$replicate))

## Add average counts to results tables
## Note that for the 'combined' celltypes, the average counts will be the same
## for each celltype contrast
res_tables_split <- map2(
    res_tables_split, avg_counts,
    ~ map2(.x, .y, function(res, avg_cnt) {
        res$avg_count <- avg_cnt[res$gene]
        res
    })
)
```

Make p-value histograms stratified by the average counts.

```{r pvalue-distributions-stratified}
pval_hist_strat_plots <- map(res_tables_split,
    ~ imap(.x, function(y, replicate) {
        replicate <- str_remove(replicate, "replicate_")
        title <- paste("Replicate:", replicate)
        pval_hist_strat(y, n_groups = 6) +
            ggtitle(title)
    })
)
```

```{r, results='asis', echo=FALSE, fig.width=12}
print_plots(pval_hist_strat_plots)
```


# Session info {-}

<details><summary>Session info</summary>

```{r session_info, echo=FALSE, cache=FALSE}
Sys.time()
git2r::repository()
sessioninfo::session_info()
```

</details>
