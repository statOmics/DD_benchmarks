---
title: "Lupus: influence of number of patients - mock results"
subtitle: "Results for `celltypes = ` `r params$celltype`"
author: "Milan Malfait & Jeroen Gilis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    theme: flatly # use darkly for dark version
    highlight: tango
    toc: yes
    toc_float: yes
    df_print: paged
    number_sections: false
    code_folding: "hide"
params:
    n_patients: !r c(10, 20, 30)
    methods: !r c("bGLM")
    celltype: "ncM"
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    fig.width = 8,
    fig.asp = 0.618,
    out.width = "100%",
    fig.align = "center",
    collapse = TRUE,
    comment = "#>"
)
```

***

```{r libraries, message=FALSE, warning=FALSE, cache=FALSE}
library(here)
library(tidyverse)
theme_set(theme_light())

library(scuttle)

library(kableExtra)
library(DDCompanion)
```

# Setup

```{r}
## Directory setup
here_root <- "benchmarks/lupus-n_patients"
here::i_am(file.path(here_root, "analysis/lupus-n_patients-mock-results.Rmd"))

res_dir <- here::here(here_root, "results")
fig_dir <- here::here(here_root, "figures")
```

```{r, echo=FALSE, results='asis'}
methods <- params$methods
celltype <- params$celltype
n_patients <- params$n_patients

if (!length(celltype) == 1) {
    stop("This report should be run for just 1 celltype only.", call. = FALSE)
}

cat(
  "\n* Using `n_patients`: ", if (is.null(n_patients)) "missing" else n_patients,
  "\n* Using `methods`: ", paste(methods, collapse = ", "),
  "\n* Using `celltype`: ", paste(celltype, collapse = ", ")
)
```

## Load results

```{r load-results}
# TODO: also add all-patients results for comparison?



res_files <- map(n_patients, ~ get_mock_res_files(
    dataset = "lupus-n_patients",
    methods = methods, celltype = celltype, datatype = "pb",
    n_patients = .x
)) %>%
    set_names(paste0("n_patients_", n_patients))

res_list <- map_depth(res_files, 2, readRDS)
str(res_list, max.level = 3)
```

## Load SCE objects

```{r load-SCE-objects}
data_files <- map(n_patients, ~ get_SCE_files(
    dataset = "lupus-n_patients", which = "mock_replicates",
    celltype = celltype, n_patients = .x
)) %>%
    set_names(paste0("n_patients_", n_patients))
sce_objects <- map(data_files, readRDS)
str(sce_objects, max.level = 3)
```

# Data overview {.tabset}

* The results were generated from `r length(sce_objects[[1]])` mock replicates
* Each replicate was generated by randomly splitting the subjects in two mock groups
* No sub-sampling of cells per patient was performed for this data
* The number of patients was randomly sub-sampled stratified by mock group

**Note** that for `n_patients` 10 and 20, the selected patients vary randomly
between the replicates, which is why the `nrows` and `ncols` are not identical.
For the `n_patients` 30, however, no random sub-sampling was done because I
could just use all patients from 2 out of the original 3 batches from the
Control samples. That's why the `nrows` and `ncols` are identical for those
subsets.

The mock group assignment of each subject also varies across replicates.

```{r data-overview}
map_dfr(sce_objects,
    ~ map_dfr(.x, function(x) c(nrows = nrow(x), ncols = ncol(x)),
        .id = "replicate"
    ),
    .id = "n_patients"
)
```

Subjects are divided across mock groups as follows:

```{r, include=FALSE}
print_content_with_headings <- function(content,
                                        header_level = 3,
                                        use_names = NULL) {

    if (!is.null(use_names)) {
        names(plotlist) <- use_names
    }

    purrr::iwalk(content, function(x, i) {
        cat("\n\n", paste(rep("#", header_level), collapse = ""), " ",
            i, "\n\n", sep = ""
        )
        print(x)
    })
}
```


## `n_patients = 10` {.tabset}

```{r, results='asis', echo=FALSE}
map(sce_objects$n_patients_10, ~ knitr::kable(table(.x$ind_cov, .x$mock_group))) %>%
    print_content_with_headings()
```

## `n_patients = 20` {.tabset}

```{r, results='asis', echo=FALSE}
map(sce_objects$n_patients_20, ~ knitr::kable(table(.x$ind_cov, .x$mock_group))) %>%
    print_content_with_headings()
```

## `n_patients = 30` {.tabset}

```{r, results='asis', echo=FALSE}
map(sce_objects$n_patients_30, ~ knitr::kable(table(.x$ind_cov, .x$mock_group))) %>%
    print_content_with_headings()
```


# Extract results of interest

## Runtimes

```{r}
runtimes <- map_dfr(res_list,
    ~ map_dfr(.x, get_runtimes, depth = 1, .id = "method"),
    .id = "n_patients"
) %>%
    mutate(n_patients = as.numeric(sub("n_patients_", "", n_patients)))
```

## P-values

```{r res_tables}
res_tables <- map_depth(
    res_list, 2,
    ~ get_aggregated_rep_tables(.x, depth = 1)
) %>%
    map(combine_tables, .id = "method")
```


# Visualize results

## Run times

```{r runtimes-plot}
ggplot(runtimes, aes(n_patients, time, col = method)) +
    geom_jitter(width = 0.5, alpha = 0.6) +
    geom_smooth(se = FALSE, method = "lm", formula = y ~ x) +
    labs(x = "Number of patients", y = "Time (seconds)", color = NULL) +
    scale_x_continuous(breaks = unique(runtimes$n_patients), minor_breaks = NULL)
```


## Number of significant genes for different FDR levels {.tabset}

```{r, message=FALSE}
n_sign_summaries <- map(res_tables, function(tmp) {
    tmp %>%
        group_by(replicate, method) %>%
        summarise(
            sum(FDR < 0.01),
            sum(FDR < 0.05),
            sum(FDR < 0.1),
            .groups = "drop"
        )
})
```

```{r, results='asis', echo=FALSE}
n_methods <- length(methods)

kbl_tables <- imap(
    n_sign_summaries,
    function(tmp, name) {
        n_replicates <- length(unique(tmp$replicate))
        pack_row_idx <- rep(n_methods, n_replicates)
        names(pack_row_idx) <- paste("Replicate:", seq_len(n_replicates))

        ## Make Kable tables for printing
        tmp %>%
            select(-replicate) %>%
            kableExtra::kbl() %>%
            kable_paper("striped") %>%
            pack_rows(index = pack_row_idx)
    }
)

iwalk(kbl_tables, function(x, i) {
    cat("\n\n### ", i, "\n\n")
    print(x)
})
```


## P-value distributions {.tabset}

```{r pvalue-distributions}
pval_figs <- map(res_tables, pval_hist)
```

```{r, results='asis', echo=FALSE, fig.width=12}
print_plots(pval_figs)
```

## P-value distributions stratified by expression level {.tabset}

For each replicate, calculate average log-normalized counts,
using `scuttle::calculateAverage()`.

```{r}
## Calculate average counts for each replicate
avg_counts <- map_depth(sce_objects, 2,
    ~ calculateAverage(counts(.x))
)

## Split res_tables per replicate
res_tables_split <- map(res_tables, ~ split(.x, .x$replicate))

## Add average counts to results tables
## Note that for the 'combined' celltypes, the average counts will be the same
## for each celltype contrast
res_tables_split <- map2(
    res_tables_split, avg_counts,
    ~ map2(.x, .y, function(res, avg_cnt) {
        res$avg_count <- avg_cnt[res$gene]
        res
    })
)
```

Make p-value histograms stratified by the average counts.

```{r pvalue-distributions-stratified}
pval_hist_strat_plots <- map(res_tables_split,
    ~ imap(.x, function(y, replicate) {
        replicate <- str_remove(replicate, "replicate_")
        title <- paste("Replicate:", replicate)
        pval_hist_strat(y, n_groups = 6) +
            ggtitle(title)
    })
)
```

```{r, results='asis', echo=FALSE, fig.width=12}
print_plots(pval_hist_strat_plots)
```


# Session info {-}

<details><summary>Session info</summary>

```{r session_info, echo=FALSE, cache=FALSE}
Sys.time()
git2r::repository()
sessioninfo::session_info()
```

</details>
